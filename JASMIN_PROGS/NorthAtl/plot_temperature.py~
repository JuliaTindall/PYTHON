#!/usr/bin/env python2.7
#NAME
#    PLOT_temperature
#PURPOSE 
#    PLOT temperature FROM LOUISE/MAX TIMESLICE EXPERIMENTS MULTIPLE FILES
#
#    We are using this as to plot the temperature across the North Atlantic 
#    sector for Jonathan holmes
#    Initially we want to plot 9-11ka and compare this with 7-8ka
#
# Julia 07.04.2019 (This was updated from plot_d18o)


# Import necessary libraries

import os
import numpy as np
import scipy as sp
import matplotlib as mp
import matplotlib.pyplot as plt
import sys
from netCDF4 import Dataset, MFDataset
from mpl_toolkits.basemap import Basemap,maskoceans, shiftgrid



# functions start here
def plotdata(plotdata,fileno,lon,lat,titlename,cbartitle,minval,maxval,diffval):
    lons, lats = np.meshgrid(lon,lat)
    if fileno <= 90:
        plt.subplot(2,2,fileno+1)
   # map=Basemap(projection='robin',resolution='l')

   # this may be a good region for the North Atlantic region
    map=Basemap(llcrnrlon=-20.0,urcrnrlon=40.0,llcrnrlat=30.0,urcrnrlat=70.0,projection='cyl',resolution='c')   

    # this may be a good region for most of the globe
    #map=Basemap(llcrnrlon=0,llcrnrlat=-80,urcrnrlon=360,urcrnrlat=80,projection='mill')

    
   # map.drawmapboundary(fill_color='aqua')
    x, y = map(lons, lats)
    map.drawcoastlines()
    #V=np.arange(np.amin(plotdata),np.amax(plotdata),np.amin(plotdata)/10)
    V=np.arange(minval,maxval,diffval)
   # cs = map.contourf(x,y,plotdata,V)
    cs=map.contourf(x,y,plotdata,V,extend='both',cmap='RdBu_r')
    #cs=map.contourf(x,y,plotdata,vmin=minval,vmax=maxval)
    plt.title(titlename)
  
    cbar=map.colorbar(cs,location='bottom',pad="5%")
    cbar.ax.tick_params(labelsize=10)
    cbar.ax.set_title(cbartitle)


def oplotdata(anom_lakes_temp,datalons,datalats,minval,maxval,diffval,lake_spel):
# plot filled circles of the data over the map
    print(anom_lakes_temp)
    V=np.arange(minval,maxval,diffval)
    print(minval,maxval)
    if lake_spel=='l': # lake
        plt.scatter(datalons,datalats,color='black',marker='o',s=110)
        plt.scatter(datalons,datalats,vmin=minval,vmax=maxval,c=anom_lakes_temp,marker='o',s=70,cmap='RdBu_r')
    if lake_spel=='s': # speleothem
        plt.scatter(datalons,datalats,color='black',marker='^',s=110)
        plt.scatter(datalons,datalats,vmin=minval,vmax=maxval,c=anom_lakes_temp,marker='^',s=70,cmap='RdBu_r')
    #plt.colorbar()
    


def getKey(item):
    return item[0]



#=====================================================
def extract_data(expt,filenames,expttime):


    # 1.  Set up details.  Gridbox required and filename


    dirname='/home/users/jctindall/mholloway/'+expt+'/pcpd/'
    os.chdir(dirname)


    #2. Set up filename and extract stash code 338
    #   print temp and dD for that file


    f=MFDataset(filenames)
    f.dimensions
    f.variables

    lon = f.variables['longitude_1'][:]
    lat = f.variables['latitude_1'][:]
    times = f.variables['t'][:]
    xsize=len(lon)
    ysize=len(lat)
    tsize=len(times)
    dD=f.variables['dD'][:]
    dD=np.squeeze(dD)
    temp=f.variables['dO18'][:]
    temp=np.squeeze(temp)
    h2o=f.variables['h2o'][:]
    h2o=np.squeeze(h2o)
    
    
    f.close()

    # we need to get annual average by weighting by precipitation amount

    dD_weight=dD*h2o
    dD_weightsum=np.sum(dD_weight,axis=0)
    temp_weight=temp*h2o
    temp_weightsum=np.sum(temp_weight,axis=0)
    tot_h2o=np.sum(h2o,axis=0)
    dD_weightavg=dD_weightsum/tot_h2o
    temp_weightavg=temp_weightsum/tot_h2o
    #print("shape tpt h2o",tot_h2o.shape)
    #print("shape mean dDweight",dD_weightsum.shape)

   # titlename=expttime
   # cbartitle='mm'
    lontemp=lon
    tot_h2o,lon=shiftgrid(180.,tot_h2o,lon,start=False,cyclic=360)
   # plotdata(tot_h2o*60.*60.*24.*30/tsize,0,lon,lat,titlename,cbartitle,0,150,10)
   # cbartitle='permil'
    lon=lontemp
    temp_weightavg,lon=shiftgrid(180.,temp_weightavg,lon,start=False,cyclic=360)
#    plotdata(temp_weightavg,2,lon,lat,titlename,cbartitle,-40,10,5)
 #   plt.show()

    retdata=[temp_weightavg,tot_h2o/tsize,lon,lat]

    return retdata





#=====================================================
def extract_data_seas(expt,filestart,expttime,monthnames):

    # 1.  Set up details.  Gridbox required and filename

 
    nmonths=len(monthnames)
    seasname=''  # get seasonname by using first letter of each month
    for mon in monthnames:
        seasname=seasname+mon[0]

    dirname='/home/users/jctindall/umoutput/BAS_timeslices/'+expt
    os.chdir(dirname)
 

    #2. Set up filename and extract stash code 338
    #   print temp and dD for that file


    for monthno in range (0,nmonths):
        print(monthno)
        filenames=filestart+monthnames[monthno]+'.nc'
        print(dirname+filenames)
        f=MFDataset(filenames)
        f.dimensions
        f.variables

        lon = f.variables['longitude'][:]
        lat = f.variables['latitude'][:]
        times = f.variables['t'][:]
        xsize=len(lon)
        ysize=len(lat)
        tsize=len(times)
        print(filenames,tsize)

        tempdata=f.variables['temp_1'][:]
        h2o_data=f.variables['precip'][:]

        if monthno ==0: 
            # we need to get annual average by weighting by precipitation amount
            all_temp=(tempdata*h2o_data) # precipitation weighted temperature
            all_h2o=h2o_data
            tsizesave=tsize
        else:
            if tsizesave != tsize:
                print('you have not got the same number of files for each month')
                print(tsizesave,tsize)

                sys.exit()

            all_temp=all_temp+(tempdata*h2o_data)
            all_h2o=all_h2o+h2o_data
    
        f.close()

    all_temp=all_temp/all_h2o     # weight by precipitation amount
    temp=np.mean(all_temp,axis=0) # climatological average
    h2o=np.mean(all_h2o,axis=0)
    temp=np.squeeze(temp)
    h2o=np.squeeze(h2o)

    print(np.shape(temp))

    lontemp=lon
    temp,lon=shiftgrid(180.,temp,lon,start=False,cyclic=360)
    lon=lontemp
    h2o,lon=shiftgrid(180.,h2o,lon,start=False,cyclic=360)


    retdata=[temp,h2o,lon,lat]

    return retdata

#====================================================================
def get_Jonathan_data(filename):
    
    f1=open(filename,'r')
    #discard titleline
    textline=f1.readline()

    datalons=[]
    datalats=[]
    data_5_7ka=[]
    data_9_11ka=[]

    for line in f1:
        linesplit=line.split(',') # the data in the file is split by comma
        datalats.append(np.float(linesplit[2]))
        datalons.append(np.float(linesplit[3]))
        data_5_7ka.append(np.float(linesplit[5]))
        data_9_11ka.append(np.float(linesplit[7]))

   
    retdata=[datalons,datalats,data_5_7ka,data_9_11ka]
    return retdata

#=================================================================
# MAIN PROGRAM STARTS HERE

print('start of program')
seasname='jfmamjjasond'
#seasname='son'
if seasname =='djf':
    monthnames=['dc','ja','fb']
if seasname =='jja':
    monthnames=['jn','jl','ag']
if seasname =='mam':
    monthnames=['mr','ar','my']
if seasname =='son':
    monthnames=['sp','ot','nv']
if seasname =='jfmamjjasond':
    monthnames=['ja','fb','mr','ar','my','jn','jl','ag','sp','ot','nv','dc']

#retdata=extract_data('xlubh','iso_xlubha@pcr[3-6]*','7ka')


# xlubh 7ka
print('about to extract')
retdata=extract_data_seas('xlubh','xlubha@pdr[3-6]*','7ka',monthnames)
temp_7ka=retdata[0]
h2o_7ka=retdata[1]
lon=retdata[2]
lat=retdata[3]

print('got 7ka')

# xlubg 6ka
retdata=extract_data_seas('xlubg','xlubga@pdr[3-6]*','6ka',monthnames)
temp_6ka=retdata[0]
h2o_6ka=retdata[1]
lon=retdata[2]
lat=retdata[3]
print('got 6ka')


# xlubf 5ka
retdata=extract_data_seas('xlubf','xlubfa@pdr[3-6]*','7ka',monthnames)
temp_5ka=retdata[0]
h2o_5ka=retdata[1]
lon=retdata[2]
lat=retdata[3]
print('got 5ka')




# xlubj 9ka
retdata=extract_data_seas('xlubj','xlubja@pdr[3-6]*','9ka',monthnames)
print('julia',retdata[0])
temp_9ka=retdata[0]
h2o_9ka=retdata[1]


# xlubk 10ka
retdata=extract_data_seas('xlubk','xlubka@pdr[3-6]*','10ka',monthnames)
temp_10ka=retdata[0]
h2o_10ka=retdata[1]


# xlubl 11ka
retdata=extract_data_seas('xlubl','xlubla@pdr[3-6]*','11ka',monthnames)
temp_11ka=retdata[0]
h2o_11ka=retdata[1]


# get average temp - weighted by amount

temp_5_7ka_wt=((temp_7ka * h2o_7ka) +  (temp_6ka * h2o_6ka)+  (temp_5ka * h2o_5ka))/(h2o_7ka+h2o_6ka+h2o_5ka)
temp_9_11ka_wt=((temp_9ka * h2o_9ka) +  (temp_10ka * h2o_10ka) + (temp_11ka * h2o_11ka))/(h2o_9ka+h2o_10ka+h2o_11ka)


# plot
plotdata((temp_9_11ka_wt-temp_5_7ka_wt)-273.15,99,lon,lat,titlename,cbartitle,-60.0,30.0,5.0)
plt.show()
sys.exit(0)

print(np.shape(temp_5_7ka), np.shape(temp_9_11ka))


# get non weighted temperature
temp_5_7ka=(temp_7ka+temp_6ka+temp_5ka)/3.
temp_9_11ka=(temp_9ka+temp_10ka+temp_11ka)/3.

# get Jonathans data
filename='/home/users/jctindall/programs/PYTHON/NorthAtl/data/Jonathan_new_data.csv'
lakedata=get_Jonathan_data(filename)
lakedatalons=lakedata[0]
lakedatalats=lakedata[1]
lakedata_5_7ka=lakedata[2]
lakedata_9_11ka=lakedata[3]

filename='/home/users/jctindall/programs/PYTHON/NorthAtl/data/speleothem_data.csv'
speleodata=get_Jonathan_data(filename)
speleodatalons=speleodata[0]
speleodatalats=speleodata[1]
speleodata_5_7ka=speleodata[2]
speleodata_9_11ka=speleodata[3]


h2o_5_7ka=(h2o_7ka+h2o_6ka+h2o_5ka)/3.0
h2o_9_11ka=(h2o_9ka+h2o_10ka+h2o_11ka)/3.0


#plotdata(temp_9_11ka,0,lon,lat,'9-11ka temp','degC',-12,-6,0.5)
#plotdata(h2o_9_11ka*60.*60.*24.*30.,1,lon,lat,'9-11ka h2o','mm/month',0,100,10)

#anom_h2o=h2o_9_11ka - h2o_5_7ka
#titlename='precip 9-11ka - 5-7ka'
#cbartitle='mm/month'
#plotdata(anom_h2o*60.*60.*24.*30,3,lon,lat,titlename,cbartitle,-10,10,1)

#print(np.shape(temp_5_7ka), np.shape(temp_9_11ka))

anom_temp=temp_9_11ka - temp_5_7ka
plt.show()
sys.exit(0)


print(np.shape(lakedata_5_7ka), np.shape(lakedata_9_11ka))
anom_lakes_temp=np.asarray(lakedata_9_11ka) - np.asarray(lakedata_5_7ka)
anom_speleo_temp=np.asarray(speleodata_9_11ka) - np.asarray(speleodata_5_7ka)

titlename='temp 9-11ka - 5-7ka '+seasname
cbartitle='permille'
#plotdata(anom_temp,2,lon,lat,titlename,cbartitle,-6,2,0.5)
plotdata(anom_temp,2,lon,lat,titlename,cbartitle,-2,1,0.2)


fileout='/home/users/jctindall/plots/python/NorthAtl/plot_temp/North_atl_9-11ka_5-7ka_'+seasname+'.eps' 
plt.savefig(fileout, bbox_inches='tight')  
fileout='/home/users/jctindall/plots/python/NorthAtl/plot_temp/North_atl_9-11ka_5-7ka_'+seasname+'.png' 
plt.savefig(fileout, bbox_inches='tight')  
plt.close()

plotdata(anom_temp,99,lon,lat,titlename,cbartitle,-2.0,2.0,0.25)
oplotdata(anom_lakes_temp,lakedatalons,lakedatalats,-2.0,2.0,0.25,'l')
oplotdata(anom_speleo_temp,speleodatalons,speleodatalats,-2.0,2.0,0.25,'s')

print('lake',lakedatalons)
print('speleo',speleodatalons)


fileout='/home/users/jctindall/plots/python/NorthAtl/plot_temp/North_atl_9-11ka_5-7ka_temp_data'+seasname+'.eps' 
plt.savefig(fileout, bbox_inches='tight')  
fileout='/home/users/jctindall/plots/python/NorthAtl/plot_temp/North_atl_9-11ka_5-7ka_temp _data'+seasname+'.png' 
plt.savefig(fileout, bbox_inches='tight')  
plt.close()



sys.exit()
