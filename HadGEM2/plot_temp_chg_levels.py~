#!/usr/bin/env python2.7
#NAME
#    PLOT_temp_chg_levels.py
#PURPOSE
#    This program will plot the temperature change between the mPWP
#    and PI by level.  We will normalise it by the surface temperature
#    change
#
# search for 'main program' to find end of functions
# Julia 22/11/2016



import os
import numpy as np
import scipy as sp
import matplotlib as mp
import matplotlib.pyplot as plt
from mpl_toolkits.axes_grid1 import make_axes_locatable
from netCDF4 import Dataset, MFDataset
import sys
from mpl_toolkits.basemap import Basemap, shiftgrid


#functions are:
#  def plotdata
#  def annmean
#  def seasmean

# functions start here
def plotdata(plotdata,fileno,lon,lat,titlename,minval,maxval,valinc,V,uselog,cbarname):
    lons, lats = np.meshgrid(lon,lat)
    plt.subplot(2,2,fileno+1)

   # this is good for a tropical region
   # map=Basemap(llcrnrlon=10.0,urcrnrlon=70.0,llcrnrlat=10.0,urcrnrlat=55.0,projection='cyl',resolution='c')
   # this is good for the globe
    map=Basemap(llcrnrlon=-180.0,urcrnrlon=180.0,llcrnrlat=-90.0,urcrnrlat=90.0,projection='cyl',resolution='l')
    #map.drawmapboundary(fill_color='aqua')
    map.drawmapboundary
    x, y = map(lons, lats)
    map.drawcoastlines()
    if V == 0:
        V=np.arange(minval,maxval,valinc)
    if uselog =='y':
        cs = map.contourf(x,y,plotdata,V,norm=mp.colors.PowerNorm(gamma=1./3.),extend="both")
        cbar = plt.colorbar(cs,orientation="horizontal")
    else:
        if uselog =='la':
            cs = map.contourf(x,y,plotdata,V,norm=mp.colors.SymLogNorm(linthresh=2.0,linscale=2.0,vmin=-32,vmax=32),cmap='RdBu_r',extend="both")
            cbar = plt.colorbar(cs,orientation="horizontal")

        else:
            if uselog =='a':
                cs = map.contourf(x,y,plotdata,V,cmap='RdBu_r',extend="both")
                cbar = plt.colorbar(cs,orientation="horizontal")
            else:
                print(np.shape(plotdata))
                cs = map.contourf(x,y,plotdata,V,extend="both")
                cbar = plt.colorbar(cs,orientation="horizontal",)

    plt.title(titlename)
    cbar.set_label(cbarname,labelpad=-40)
#end def plotdata

def annmean(preind_expt,plio_expt,pliop2_expt,extra,HadCM3):
   

    if HadCM3 == 'y':
        filepi='/nfs/hera1/earjcti/um/'+preind_expt+'/netcdf/'+preind_expt+'a@pc'+extra+'[7-9]*.nc'
        fileplio='/nfs/hera1/earjcti/um/'+pliop2_expt+'/netcdf/'+pliop2_expt+'a@pc'+extra+'[7-9]*.nc'
    else:
        filepi='something'
        fileplio='something'

    # get preindustrial data
    f=MFDataset(filepi)
    lat = f.variables['latitude_1'][:]
    lon = f.variables['longitude_1'][:]
    pressure = f.variables['p'][:]
    atemp=f.variables['temp'][:]
  
    temp_pi=np.mean(atemp,axis=0)
    temp_pi=np.squeeze(temp_pi)
    nz,ny,nx=np.shape(temp_pi)
  

   # get pliocene data
    f=MFDataset(fileplio)
    lat = f.variables['latitude_1'][:]
    lon = f.variables['longitude_1'][:]
    pressure = f.variables['p'][:]
    atemp=f.variables['temp'][:]
  
    temp_plio=np.mean(atemp,axis=0)
    temp_plio=np.squeeze(temp_pi)
   

    # get pliocene-preindustrial data
    temp_diff=temp_plio-temp_pi

    nplots=4
    for figure in range(0,np.floor(nz/nplots)):
       for i in range(0,nplots):
          titlename='tdiff at pressure'+p[(figure *nplots)+i]
          plotdata(temp_diff[(figure *nplots)+i,:,:],i,lon,lat,titlename,-50,50,5.0,0.0,'n',degC)
          #plotdata(temp_diff((0,:,:),i,lon,lat,titlename,-50,50,5.0,0.0,'n',degC)
       plt.show()
       sys.exit() 
      


     #==============
     # Pliocene

    if HadCM3 == 'y':
        f=MFDataset('/nfs/hera1/earjcti/um/netcdf/xibol_netcdf/xibola@pdy[7-9]*.nc')
        lat = f.variables['latitude'][:]
        lon = f.variables['longitude'][:]
        atemp=f.variables['temp'][:]
        titlePlio='Plio-TAnn_HadCM3'

    else:
        f=MFDataset('/nfs/hera1/earjcti/um/HadGEM_data/xkvjf/temp_data/xkvjfa@pdn[7-9]*.nc')
        atemp=f.variables['temp_1'][:]
        titlePlio='Plio-TAnn_HadGEM2'


    atemp=np.squeeze(atemp)
    ntimes,ny,nx=np.shape(atemp)
    print(ntimes,ny,nx)

    plio_temp_ann=np.mean(atemp,axis=0)
    print('new shape plio',np.shape(plio_temp_ann))

    lon=lontemp
    plio_temp_ann,lon = shiftgrid(180.,plio_temp_ann,lon,start=False)

    plotdata(plio_temp_ann-273.15,1,lon,lat,titlePlio,-50,50,5.0,0.0,'n',degC)


     #==============
     # Pliocene+2

    if HadCM3 != 'y':
        # read in data from multiple files
        f=MFDataset('/nfs/hera1/earjcti/um/HadGEM_data/xkvjg/temp_data/xkvjga@pdn[7-9]*.nc')
        atemp=f.variables['temp_1'][:]
        atemp=np.squeeze(atemp)
        ntimes,ny,nx=np.shape(atemp)
        print(ntimes,ny,nx)
        
    #average across the time dimension
        plio_tempp2_ann=np.mean(atemp,axis=0)
        print('new shape plio',np.shape(plio_tempp2_ann))
        lon=lontemp
        plio_tempp2_ann,lon = shiftgrid(180.,plio_tempp2_ann,lon,start=False)




    # Pliocene - preindustrial

    plio_anom=plio_temp_ann-pi_temp_ann

    #V=[-32,-16,-8,-4,-2,-1,-0.5,0,0.5,1,2,4,8,16,32]
    plotdata(plio_anom,2,lon,lat,titlediff,0,10,1.0,0,'n',degC)
    
    # Pliocene+2 - preindustrial

    if HadCM3 != 'y':
        pliop2_anom=plio_tempp2_ann-pi_temp_ann
        #V=[-32,-16,-8,-4,-2,-1,-0.5,0,0.5,1,2,4,8,16,32]
        plotdata(pliop2_anom,3,lon,lat,'PlioP2 - PI Tanom_HG2',0,10,1.0,0,'n',degC)


    if HadCM3 == 'y':
        fileout='/nfs/see-fs-02_users/earjcti/PYTHON/PLOTS/HadGEM2/plot_surftemp/MAT_anom_HadCM3.eps' 
        plt.savefig(fileout, bbox_inches='tight')  
        fileout='/nfs/see-fs-02_users/earjcti/PYTHON/PLOTS/HadGEM2/plot_surftemp/MAT_anom_HadCM3.tiff' 
        plt.savefig(fileout, bbox_inches='tight')  


    else:
        fileout='/nfs/see-fs-02_users/earjcti/PYTHON/PLOTS/HadGEM2/plot_surftemp/MAT_anom.eps' 
        plt.savefig(fileout, bbox_inches='tight')  
        fileout='/nfs/see-fs-02_users/earjcti/PYTHON/PLOTS/HadGEM2/plot_surftemp/MAT_anom.tiff' 
        plt.savefig(fileout, bbox_inches='tight')  


    
    plt.close()


     # get land mask and put on correct grid

    if HadCM3 != 'y':
        fm=Dataset('/nfs/hera1/earjcti/um/HadGEM_ancils/qrparm.mask.nc')
    else:
        fm=Dataset('/nfs/hera2/apps/metadata/ancil/preind2/qrparm.mask.nc')
    lsmlon=fm.variables['longitude'][:]
    lsmlat=fm.variables['latitude'][:]
    lsm=fm.variables['lsm'][:]
    lsm=np.squeeze(lsm)
    lsm,lsmlon = shiftgrid(180.,lsm,lsmlon,start=False)
    fm.close()

   

    if (np.array_equal(lsmlon,lon)) and (np.array_equal(lsmlat,lat)):
        anom_land=plio_anom / lsm
        anom_sea=plio_anom / np.abs(lsm-1.0)
    else:
        print('error lon/lat of land sea mask dont match')
        anom_land=plio_anom * lsm
        plotdata(anom_land,99,lon,lat,'a) mPWP temperature anomaly',0,10,1.0,V,'i',degC)
        plt.show()
        sys.exit()



    # print temperature changes
    # create weighting array
    weightarr=np.zeros(np.shape(anom_sea))
    for i in range(0,len(lon)):
        weightarr[:,i]=np.cos(np.deg2rad(lat))

    print('mean anom_sea',np.average(plio_anom,weights=weightarr * np.abs(lsm-1.0)))
    print('mean anom_land',np.average(plio_anom,weights=weightarr*lsm))
    print('allmean',np.average(plio_anom,weights=weightarr))


    # plot temperature change by latitude    

    lat_avg_diff=np.average(plio_anom,axis=1)
    print(lat_avg_diff)
    print(np.shape(lat_avg_diff))
    allavg=np.average(lat_avg_diff,weights=np.cos(np.deg2rad(lat)))
    plt.plot(lat,lat_avg_diff)
    

    # find temperature change poleward of 60deg
    nhsum=0.
    nhsum_weights=0.
    shsum=0.
    shsum_weights=0.
    for j in range(0,len(lat)):
        if lat[j] >= 60:
            print(lat[j],lat_avg_diff[j])
            nhsum=nhsum+(lat_avg_diff[j] * np.cos(np.deg2rad(lat[j])))
            nhsum_weights=nhsum_weights+(np.cos(np.deg2rad(lat[j])))
        if lat[j] <= -60:
            shsum=shsum+(lat_avg_diff[j] * np.cos(np.deg2rad(lat[j])))
            shsum_weights=shsum_weights+(np.cos(np.deg2rad(lat[j])))
    print('nh t change poleward 60N=',nhsum/nhsum_weights)
    print('sh t change poleward 60S=',shsum/shsum_weights)

 # find temperature change poleward of 75deg
    nhsum=0.
    nhsum_weights=0.
    shsum=0.
    shsum_weights=0.
    for j in range(0,len(lat)):
        if lat[j] >= 75:
            print(lat[j],lat_avg_diff[j])
            nhsum=nhsum+(lat_avg_diff[j] * np.cos(np.deg2rad(lat[j])))
            nhsum_weights=nhsum_weights+(np.cos(np.deg2rad(lat[j])))
        if lat[j] <= -75:
            shsum=shsum+(lat_avg_diff[j] * np.cos(np.deg2rad(lat[j])))
            shsum_weights=shsum_weights+(np.cos(np.deg2rad(lat[j])))
    print('nh t change poleward 75N=',nhsum/nhsum_weights)
    print('sh t change poleward 75S=',shsum/shsum_weights)
    


#end def annmean


################################
# main program

# annual mean
preind_expt='xiboi'
plio_expt='xibol'
pliop2_expt='xibol'
extra='y'
HadCM3='y'
annmean(preind_expt,plio_expt,pliop2_expt,extra,HadCM3)




sys.exit(0)

####

