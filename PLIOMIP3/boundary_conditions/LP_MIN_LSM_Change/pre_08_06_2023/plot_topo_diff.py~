#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created May 2022 by Julia

This program will plot the difference in topography between the 
LP_MIN_LSM_Change experiment and EOI400 from PlioMIP2
This is for inclusion in Alans paper.  

"""

import numpy as np
import iris
import iris.quickplot as qplt
import iris.plot as iplt
import matplotlib.pyplot as plt
import netCDF4
from datetime import date
import cartopy.crs as ccrs
import matplotlib.colors as mplcol
from matplotlib.collections import LineCollection
import sys


def get_files(fileend, eoi400_fieldname, lp_min_lsm_fieldname):
    """
    gets the original and new pliocene
    """

    filestart = '/nfs/hera1/earjcti/PlioMIP2_Boundary_conds/'     
    eoi400_filename = 'Plio_enh/Plio_enh/Plio_enh_' + fileend + '.nc'
    eoi400_cube = iris.load_cube(filestart + eoi400_filename,eoi400_fieldname)

    minlsm_cube = iris.load_cube('LP_MinLSM_topo_v1.0.nc',lp_min_lsm_fieldname)
    
    e280_cube = iris.load_cube(filestart + 'Modern_std/Modern_std/Modern_std_topo_v1.0.nc','etopo1_topo')
   
    return eoi400_cube, minlsm_cube, e280_cube


###############################################
def plot_difference(cubeminLSM, cubeEOI400):
    """
    here we plot the difference between the two topographies
    """

    cubediff= cubeminLSM - cubeEOI400
    cubediff.data.mask = np.where(cubediff.data==0.0, 1.0, 0.0)

    
    # get pliocene land sea mask
    eoi400lsm = '/nfs/hera1/earjcti/PlioMIP2_Boundary_conds/Plio_enh/Plio_enh/Plio_enh_LSM_v1.0.nc'
    eoi400_lsmcube=iris.load_cube(eoi400lsm)
  
    e280lsm = '/nfs/hera1/earjcti/PlioMIP2_Boundary_conds/Modern_std/Modern_std/Modern_std_LSM_v1.0.nc'
    e280_lsmcube=iris.load_cube(e280lsm)
  


    # plot
   
    ax=plt.subplot(2,2,1,projection=ccrs.NorthPolarStereo())
    ax.set_extent([-180,180,55,90],ccrs.PlateCarree())
    cs=iplt.pcolormesh(cubediff, cmap='winter',vmin=-200,vmax=0)
    plt.colorbar(cs,orientation='horizontal')
    qplt.contour(e280_lsmcube,[0.5],colors='red',linewidths=0.75)
    qplt.contour(eoi400_lsmcube,[0.5],colors='black',linewidths=0.75,linestyle='dashed')
    ax.gridlines()
   
   # plt.gca().coastlines()
    plt.title('LP_MIN_LSM - EOI400')

    ax=plt.subplot(2,2,2,projection=ccrs.PlateCarree())
    ax.set_extent([90,180,-30,30],ccrs.PlateCarree())
    cs=iplt.pcolormesh(cubediff, cmap='winter',vmin=-200,vmax=0)
    plt.colorbar(cs,orientation='horizontal')
    qplt.contour(e280_lsmcube,[0.5],colors='red',linewidths=0.75)
    qplt.contour(eoi400_lsmcube,[0.5],colors='black',linewidths=0.75,linestyle='dashed')
    ax.gridlines()
   # plt.gca().coastlines()
    plt.title('LP_MIN_LSM - EOI400')


    ax=plt.subplot(2,2,3,projection=ccrs.PlateCarree())
    ax.set_extent([-90,-30,70,90],ccrs.PlateCarree())
    cs=iplt.pcolormesh(cubediff, cmap='winter',vmin=-200,vmax=0)
    plt.colorbar(cs,orientation='horizontal')
    qplt.contour(e280_lsmcube,[0.5],colors='red',linewidths=0.75)
    qplt.contour(eoi400_lsmcube,[0.5],colors='black',linewidths=0.75,linestyle='dashed')
    ax.gridlines()
   # plt.gca().coastlines()
    plt.title('CAA: LP_MIN_LSM - EOI400')


    ax=plt.subplot(2,2,4,projection=ccrs.PlateCarree(central_longitude=180))
    ax.set_extent([-200,-150,50,80],ccrs.PlateCarree())
    cs=iplt.pcolormesh(cubediff, cmap='winter',vmin=-200,vmax=0)
    plt.colorbar(cs,orientation='horizontal')
    qplt.contour(e280_lsmcube,[0.5],colors='red',linewidths=0.75)
    qplt.contour(eoi400_lsmcube,[0.5],colors='black',linewidths=0.75,linestyle='dashed')
    ax.gridlines()
   # plt.gca().coastlines()
    plt.title('BS: LP_MIN_LSM - EOI400')


    plt.tight_layout()
    plt.show()
    
    sys.exit(0)
    plt.savefig('LSM_anom.png')


###############################################
def plot_global_difference(cubeminLSM, cubeEOI400, cubeE280):
    """
    here we find where the topographies are different
    and plot the depth of the ocean in the new topography
    """


    def add_iso_line(ax, x, y, lsm, value, color):
        """
        this will draw the land sea mask around squar boxes
        """

        # x is currengly 0.5, 1.5, ....359.5
        # we will use instead -180, -179, -178, -177,....180 for drawing
        x=np.arange(-180.0,181.0,1.0)

        # y is currently -89.5, -88.5,.......88.5, 89.5
        # we will use instead -90.0, -89.0,   89.0, 90.0 for drawing
        y=np.arange(-90.0, 91.0, 1.0)
    
      
        v=np.diff(lsm > value, axis=1)
        h=np.diff(lsm > value, axis=0)

        l=np.argwhere(v.T)  # this is a list of lines to draw.
                            # v.T is where the line should be drawn
        print(l)
        print(np.stack((x[l[:, 0] + 1], y[l[:, 1]])).T)
       
        vlines=np.array(list(zip(np.stack((x[l[:, 0] + 1], y[l[:, 1]])).T,
                                 np.stack((x[l[:, 0] + 1], y[l[:, 1] + 1])).T)))

        l=np.argwhere(h.T)
        print(np.shape(x),np.shape(y), l[0,:])
        print(l)
        print(np.shape(l))
      
        for i in range(0,len(l[:,0])):
            line = l[i,:]
            print(i,line)
            print(x[line[0]],y[line[1]])

        hlines=np.array(list(zip(np.stack((x[l[:, 0]], y[l[:, 1] + 1])).T,
                                 np.stack((x[l[:, 0] + 1], y[l[:, 1]+1])).T)))

        lines =  np.vstack((vlines,hlines))
        ax.add_collection(LineCollection(lines, lw=1, colors=color))

    #  end of embedded subroutine
    ####################################################################

    fig = plt.figure(figsize=[15.0, 12.0])
    cubediff= cubeminLSM - cubeEOI400
    cubediff.data.mask = np.where(cubediff.data==0.0, 1.0, 0.0)
    # find where land in both pliocene and pi
    land = np.where(cubeEOI400.data > 0.0, 1.0, 0.0)
    land = np.where(cubeE280.data > 0.0, land, 0.0)

    minLSMdepth = np.ma.where(cubediff.data != 0.0, cubeminLSM.data, 0.0)
    # put land on both to a high value
    minLSMdepth = np.ma.where(land, 100, minLSMdepth)

    # if land set on both set mask to false
    # otherwise mask out bits that haven't changed
    minLSMdepth.mask = np.where(cubediff.data==0.0, True, False)
    minLSMdepth.mask = np.where(land == 1.0, False, minLSMdepth.mask)

    minLSMdepth_cube = cubeminLSM.copy(data=minLSMdepth)
    minLSMdepth_cube.data.mask = np.where(minLSMdepth_cube.data==0.0, 1.0, 0.0)
    #minLSMdepth_cube.data.mask = minLSMdepth_mask
    cubediff=0

  
    
    # get pliocene land sea mask
    eoi400lsm = '/nfs/hera1/earjcti/PlioMIP2_Boundary_conds/Plio_enh/Plio_enh/Plio_enh_LSM_v1.0.nc'
    eoi400_lsmcube_origgrid=iris.load_cube(eoi400lsm)
  
    e280lsm = '/nfs/hera1/earjcti/PlioMIP2_Boundary_conds/Modern_std/Modern_std/Modern_std_LSM_v1.0.nc'
    e280_lsmcube_origgrid=iris.load_cube(e280lsm)
    newgrid = e280_lsmcube_origgrid.copy()
    print(newgrid.coord('longitude').points)
    newlons = np.arange(0.5, 360.5, 1.0)
    newgrid.coord('longitude').points = newlons
    e280lsmcube = e280_lsmcube_origgrid.regrid(newgrid,iris.analysis.Linear())
    eoi400lsmcube = eoi400_lsmcube_origgrid.regrid(newgrid,iris.analysis.Linear())
  


    # plot

    # set up colormap
    #boundaries = np.arange(-1000., 1100., 100)
    boundaries=np.arange(-100,10,10)
    cmap_winter = plt.cm.get_cmap('cool',len(boundaries))
    colors=list(cmap_winter(np.arange(len(boundaries))))
    cmap_winter.set_over('gray')  # put land as grey
    cmap_winter.set_under('gray')  # set to first color


    crs180 = ccrs.PlateCarree(central_longitude=180.) #for plotting map
    ax=plt.subplot(1,1,1,projection=crs180)
    #ax.set_extent([-180,180,55,90],ccrs.PlateCarree())
    cs=iplt.pcolormesh(minLSMdepth_cube, cmap=cmap_winter,
                       norm = mplcol.BoundaryNorm(boundaries, 
                                                  ncolors=len(boundaries)-1,
                                                  clip=False))
    cmap2=cs.get_cmap()
    cmap2.set_over('blue')
    cs.set_cmap(cmap2)

    add_iso_line(ax, e280lsmcube.coord('longitude').points,
                 e280lsmcube.coord('latitude').points,
                 e280lsmcube.data, 0.9, 'orange')#

    #qplt.contour(e280lsmcube,[0.5],colors='red',linewidths=0.75)
    

    add_iso_line(ax, eoi400lsmcube.coord('longitude').points,
                 eoi400lsmcube.coord('latitude').points,
                 eoi400lsmcube.data, 0.9, 'black')#
    #qplt.contour(eoi400lsmcube,[0.5],colors='green',linewidths=0.75),
   

    #ax.gridlines()
   
    cbar=plt.colorbar(cs,orientation='horizontal',extend='both')
    cbar.set_label('depth (m)',size=30)
    cbar.ax.tick_params(labelsize=30)
    plt.title(' ')

   
 
    plt.tight_layout()
    plt.show()
    sys.exit(0)
    plt.savefig('LSM_global_anom.jpeg')
    plt.savefig('LSM_global_anom.pdf')
    plt.savefig('LSM_global_anom.eps')
    plt.savefig('LSM_global_anom.png')
   
   
     
###############################################
# main program


# get Pliocene and preindustrial files

(eoi400_topo_cube, 
 LP_minLSM_cube, e280_topo_cube) = get_files('topo_v1.0','p4_topo',
                                             'p4_topo_Min_LSM_Chg')

# plot the difference between the two cubes
#plot_difference(LP_minLSM_cube, eoi400_topo_cube)
plot_global_difference(LP_minLSM_cube,eoi400_topo_cube, e280_topo_cube)
