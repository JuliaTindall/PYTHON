
# redo to use theta rather than deltaT


# we are going to calculate the ocean heat transport over the full depth
# of the ocean. I think this is fine as temperature gradients are not very
# large at the deepest layers
import iris
import numpy as np
import matplotlib.pyplot as plt
import sys

expt='xqbwe'
startyear=3970
endyear=3973



def get_OHT(expt,year):
    """
    Calculates ocean heat transport in Peta Watts for the year
    """
    density=1025
    cp=4000

    filename = ('/home/earjcti/um/'+expt+'/pg/' +expt + 'o#pg00000'
                +str(year) + 'c1+.nc')

    vcube = iris.load_cube(filename,'TOTAL OCEAN V-VELOCITY      CM S**-1')
    vcube = iris.util.squeeze(vcube) / 100. # convert to m/s
    Tcube_origgrid = iris.util.squeeze(iris.load_cube(filename,
                    'POTENTIAL TEMPERATURE (OCEAN)  DEG.C'))
    Tcube = Tcube_origgrid.regrid(vcube,iris.analysis.Linear())

    # get stuff we need for area
    depths = vcube.coord('depth_1').points
    lons = vcube.coord('longitude').points
    lats = vcube.coord('latitude').points
    lonres=lons[1]-lons[0]
    depdiff = np.zeros(20)
    for k in range(1,19):
        depdiff[k]=(depths[k+1] - depths[k-1]) / 2.0
    depdiff[0]=depths[1]-depths[0]
    depdiff[19]=depths[19]-depths[18]

    lats = vcube.coord('latitude').points
    coslats = np.cos(lats * 2.0 * np.pi / 360.) # cos latitude of vacross
    onedeg=111100.   # 111.1 km

    area_arr = np.zeros_like(vcube.data,dtype=float)
    area_arr[:]=depdiff[:,np.newaxis,np.newaxis] # add depth
    area_arr[:]=(area_arr[:] *
                 onedeg * coslats[np.newaxis,:,np.newaxis] * lonres)
    area_cube = vcube.copy(data=area_arr)
    
    Qcube = density * cp * vcube * Tcube * area_cube
    Qcube = Qcube / 1.0E15
    Qcube.data = np.ma.where(Qcube.data.mask,-99999.,Qcube.data)
    Qcube.data = np.ma.masked_where(Qcube.data==-99999.,Qcube.data)
    Qcube.units = 'PW'
    Qcube.long_name = 'Ocean heat transport petawatts'
    Tcube.data = np.ma.where(Tcube.data.mask,-99999.,Tcube.data)
    Tcube.long_name = 'potT'
    Qcube_zm = Qcube.collapsed('longitude',iris.analysis.SUM)
    Qcube_zm.long_name = 'Ocean heat transport (PW) summed over longitude'
    Qcube_int = Qcube_zm.collapsed('depth_1',iris.analysis.SUM)
    Qcube_int.long_name = 'Depth integrated Ocean heat transport (PW)'

    lats=Qcube_int.coord('latitude').points
  
    return lats,Qcube_int.data


years = []
lats_allyears = []
OHT_allyears = []
for year in range(startyear,endyear):
    lats,OHT = get_OHT(expt,year)
    years.append(year)
    lats_allyears.append(lats)
    OHT_allyears.append(OHT)

# save to file
filestart = '/home/earjcti/um/' + expt  
fileout = filestart + '/timeseries/OHT_' + expt + '_' + str(startyear) + '_' + str(endyear) + '.tex'
    
with open(fileout, 'w') as f:
    f.write(f"year,{lats}\n")
    for x, y in zip(years, OHT_allyears):
        f.write(f"{x},{y},\n")
    f.close()
